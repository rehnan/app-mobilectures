<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />

    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/sails.io.js"></script>
    <script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="js/jquery.mobile-1.4.5.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <link rel="stylesheet" type="text/css" href="css/jquery.mobile-1.4.5.css" />
    <title>Hello World</title>
</head>
<body>
<div data-role="page" id="page-join" data-title="Join">
    <!-- Início Header -->
    <div data-role="header">
        <center><span class="connection-info">Connected!</span></center>
        <div data-role="navbar">
            <ul>
                <li><a href="#page-join" class="ui-btn-active ui-state-persist" > Join </a></li>
                <li><a href="#page-signup" data-transition="slide" data-direction="reverse" > Signup </a></li>
            </ul>
        </div>
    </div> <!-- Fim Header -->
    <!-- Conteúdo -->
    <div data-role="main" class="ui-content">
        <div class="ui-grid-b my-breakpoint input-session-key">
            <form id="formJoinSession">
                <label for="input-key-session">Session Key:</label>
                <input name="input-key-session" class="error" id="input-key-session" placeholder="Chave de Sessão"  type="number">
                <div class="ui-grid-solo">
                    <div class="ui-block-a"> <button type="button" class="ui-btn ui-corner-all ui-shadow ui-btn-b submit-session">Join</button> </div>
                </div>
            </form>
            <img src="./img/logo.png" class="image-logo"/>
        </div>
    </div>

    <!-- Pop Up Login-->
    <div data-role="popup" id="popupLogin" data-theme="a" class="ui-corner-all">
        <form id="form-signin">
            <div style="padding:15px 15px">
                <span><b>Please sign in</b></span>
                <input type="text" name="user_email" id="user_email" value="" placeholder="Email" >
                <input type="password" name="user_password" id="user_password" value="" placeholder="Senha" >
                <button type="submit" class="ui-btn ui-corner-all ui-shadow ui-btn-b submit-signin">Sign in</button>
                <input type="checkbox" name="checkbox-mini-0" id="checkbox-mini-0" data-mini="true">
                <label for="checkbox-mini-0">Salvar email e login</label>
            </div>
        </form>
    </div>
    <!-- FIm do popup Login -->
    <!--Fim conteúdo -->

    <!-- Footer -->
    <div data-role="footer" data-position="fixed">
        <h2>Mobilectures &copy; 2015</h2>
    </div>
    <!-- Fim Footer -->
</div> <!-- Fim Page Join -->

<!-- #################################################################################### -->

<div data-role="page" id="page-signup" data-title="Signup">
    <div data-role="header">
        <center><span class="connection-info"></span></center>
        <div data-role="navbar">
            <ul>
                <li><a href="#page-join" data-transition="slide" > Join </a></li>
                <li><a href="#page-signup"  class="ui-btn-active ui-state-persist"  > Signup </a></li>
            </ul>
        </div>
    </div>

    <div data-role="main" class="ui-content">
        <form id="form-signup">
            <label for="name">Nome:</label>
            <input  name="name" id="name" placeholder="Informe seu nome">
            <label for="email">Email:</label>
            <input  name="email" id="email" placeholder="Informe seu email">
            <label for="password">Password:</label>
            <input  name="password" id="password" placeholder="Informe sua senha">
            <div class="ui-grid-solo">
                <div class="ui-block-a"><button type="button" class="submit" >Signup</button></div>
            </div>
        </form>
    </div>

    <div data-role="footer" data-position="fixed">
        <h2>Mobilectures &copy; 2015</h2>
    </div>
</div>


<!-- ################################################################################# INDEX-->
<div data-role="page" id="page-listener" data-title="Dashboard">
    <div data-role="header">
        <center><span class="connection-info"></span></center>
        <div data-role="navbar">
            <ul>
                <li><button class="ui-btn ui-shadow signout">Logout</button></li>
            </ul>
        </div>
    </div>

    <div data-role="main" class="ui-content"><h3>Welcome to the Listener Dashboard!</h3></div>

    <div data-role="footer" data-position="fixed">
        <h2>Mobilectures &copy; 2015</h2>
    </div>
</div>

<script type="text/javascript" src="js/socket.io.connection.js"></script>
<script type="text/javascript">
$(document).ready(function() {

     app.initialize();
     //Signout event click
      $(".signout").bind("click", function(){
             u_id = window.localStorage.getItem("u_id");
             session_key = window.localStorage.getItem("session_key");
             socket.post('/speaker/listeners/leave', {sessionKey:session_key, userId:u_id}, function (data, jwres){
             });
              $.mobile.changePage("#page-join");
      });


    //Método POST para cadastrar uma nova conta no servidor
     $(".submit").bind("click", function(){
            //Recuperando valores dos inputs
           var name = $.trim($('#form-signup').find('input[name="name"]').val());
           var email = $.trim($('#form-signup').find('input[name="email"]').val());
           var password = $.trim($('#form-signup').find('input[name="password"]').val());

           if((name == "") || (email == "") || (password == "")){
                    alert('Sáporra tá vazia!');
            }else{
             socket.post('/speaker/listeners/create', {name:name, email:email, password:password}, function (data, jwres){

              });
              $.mobile.changePage("#page-join");
          }
     });

     //Método para autenticação no sistema
     $(".submit-session").bind("click", function(event, ui) {
                var keySession = $('.input-session-key').find('input[name="input-key-session"]');
                if($.trim(keySession.val()) == ""){
                    alert('Saporra tá vazia!');
                    keySession.focus();
                }else{
                     $("#popupLogin").popup( "open");
                }
     });

     //Método para submit do login
     $(".submit-signin").bind("click", function(event, ui) {
           var keySession =  $.trim($('.input-session-key').find('input[name="input-key-session"]').val());
           var user_email = $.trim($('#form-signin').find('input[name="user_email"]').val());
           var user_password = $.trim($('#form-signin').find('input[name="user_password"]').val());
          alert(keySession);
           if((user_email == "") || (user_password == "")){
                    return false;
            }else{

            socket.get('/speaker/listeners/join', {email:user_email, password:user_password, keySession:keySession}, function (response, jwres){
                     switch (response.authorization) {
                        case 'true':
                             window.localStorage.setItem("session_key", response.session);
                             window.localStorage.setItem("u_id", response.listener.id);
                             window.localStorage.setItem("u_email", response.listener.email);
                             window.localStorage.setItem("u_name", response.listener.name);
                             alert("Authorization: "+ response.authorization);

                             $.mobile.changePage("#page-listener");
                          break;
                        case 'false':
                            alert("Authorization: "+ response.authorization);
                            $.mobile.changePage("#page-join");
                          break;
                        default:
                          break;
                      }
              });
          }
     });
});
</script>
</body>
</html>

